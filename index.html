<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsão do Tempo</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap');

        body {
            font-family: "Ubuntu", sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            font-size: 28px;
        }

        #search-box {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 600px;
        }

        #search-box input {
            flex: 1;
            font-size: 22px;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-family: "Ubuntu", sans-serif;
        }

        #search-box button {
            background-color: #282828;
            color: white;
            font-size: 22px;
            border-radius: 8px;
            padding: 8px 14px;
            font-family: "Ubuntu", sans-serif;
        }

        #location {
            margin: 30px 0;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 14px 16px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-sizing: border-box;
            width: 100%;
        }

        .dia-data {
            font-weight: bold;
            font-size: 22px;
            text-align: left;
            margin: 0px 0px 10px 0px;
        }

        .metricas-linha {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 20px;
            text-align: center;
        }

        .metricas-linha>div {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 18px;
            align-items: center;
        }

        .metricas-linha>div span:last-child {
            font-weight: bold;
        }

        .chuva {
            background-color: #cceaff;
        }

        .temp {
            background-color: #ffbfa3;
        }

        .vento {
            background-color: #c7ffbe;
        }

        .rajadas {
            background-color: #c7ffbe;
        }

        .umid {
            background-color: #cceaff;
        }

        .sol {
            background-color: #fff6a1;
        }

        .alerta {
            font-size:18px;
            margin-top:5px;
            text-align: center;
            margin-bottom: 0px;
            font-weight: bolder;
            color: #eb4848;
        }

        .weather-details {
            max-height: 0;
            overflow: hidden;
            background: #fff;
            border-radius: 8px;
            margin-top: 6px;
            box-sizing: border-box;
            transition: max-height 360ms ease, padding 360ms ease;
            will-change: max-height;
            padding: 0 4px;
        }

        .weather-details.open {
            padding: 10px 4px;
        }

        .weather-details p {
            display: flex;
            gap: 20px;
            padding: 10px;
            font-size: 20px;
        }

        .current-hour {
            background-color: #befaff;
            border-radius: 4px;
        }

        @media (max-width: 700px) {
            #search-box {
                display: flex;
                flex-direction: column;
                gap: 5px;
                justify-content: center;
                margin-bottom: 15px;
            }

            #search-box input {
                font-size: 22px;
                border-radius: 8px;
                padding: 8px;
            }

            #serch-button {
                border-radius: 8px;
            }

            .cards {
                width: 100%;
            }

            .metricas-linha {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .weather-details p {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <h1>Previsão 16 dias - Open Meteo</h1>

    <div id="search-box">
        <input type="text" id="city-input" placeholder="Digite a cidade">
        <button id="search-btn">Buscar</button>
    </div>

    <div id="location">Carregando localização...</div>

    <div id="cards-container" class="cards"></div>

    <script>
        const weatherDescriptions = {
            0: "Céu limpo", 1: "Algumas nuvens", 2: "Muitas nuvens", 3: "Nublado",
            45: "Névoa", 48: "Neblina", 51: "Chuvisco fraco", 53: "Chuvisco moderado",
            55: "Chuvisco forte", 56: "Garoa congelante fraca", 57: "Garoa congelante forte",
            61: "Chuva fraca", 63: "Chuva moderada", 65: "Chuva forte", 66: "Chuva congelante fraca",
            67: "Chuva congelante forte", 71: "Neve fraca", 73: "Neve moderada", 75: "Neve forte",
            77: "Cristais de gelo", 80: "Pancadas de chuva fraca", 81: "Pancadas de chuva moderada",
            82: "Pancadas de chuva forte", 85: "Pancadas de neve fraca", 86: "Pancadas de neve forte",
            95: "Risco de trovoadas", 96: "Tempestades com granizo", 99: "Tempestades fortes com granizo"
        };

        function clearContainer() {
            document.getElementById('cards-container').innerHTML = '';
        }

        function createWeatherMenu(hourlyTimes, hourlyCodes, isToday) {
            const div = document.createElement('div');
            div.classList.add('weather-details');

            const currentHour = new Date().getHours();
            for (let i = 0; i < hourlyTimes.length; i++) {
                const date = new Date(hourlyTimes[i]); // aqui pode manter, pois hourly tem hora
                const hora = date.getHours();
                const desc = weatherDescriptions[hourlyCodes[i]] || `Código ${hourlyCodes[i]}`;
                const p = document.createElement('p');
                p.innerHTML = `<span><b>${String(hora).padStart(2, '0')}:00</b></span><span style="color: gray;">${desc}</span>`;
                if (isToday && hora === currentHour) p.classList.add('current-hour');
                div.appendChild(p);
            }
            return div;
        }

        // animações
        function openDetails(details, card) {
            details.classList.add('open');
            details.style.maxHeight = details.scrollHeight + 'px';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const top = card.getBoundingClientRect().top + window.scrollY - 10;
                    window.scrollTo({ top, behavior: 'smooth' });
                });
            });
            const onEnd = (ev) => {
                if (ev.propertyName === 'max-height') {
                    details.style.maxHeight = 'none';
                    details.removeEventListener('transitionend', onEnd);
                }
            };
            details.addEventListener('transitionend', onEnd);
        }

        function collapseDetails(details) {
            if (!details.classList.contains('open')) return;
            details.style.maxHeight = details.scrollHeight + 'px';
            void details.offsetHeight;
            details.style.maxHeight = '0px';
            details.classList.remove('open');
            const onEnd = (ev) => {
                if (ev.propertyName === 'max-height') {
                    details.style.maxHeight = '';
                    details.removeEventListener('transitionend', onEnd);
                }
            };
            details.addEventListener('transitionend', onEnd);
        }

        function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,uv_index_clear_sky_max,uv_index_max,sunshine_duration,daylight_duration,sunset,sunrise,rain_sum,showers_sum,snowfall_sum,precipitation_sum,precipitation_hours,precipitation_probability_max,et0_fao_evapotranspiration,shortwave_radiation_sum,wind_direction_10m_dominant,wind_gusts_10m_max,wind_speed_10m_max,relative_humidity_2m_max,relative_humidity_2m_min&hourly=weather_code&timezone=auto&forecast_days=16`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (!data?.daily?.time) return;

                    const d = data.daily;
                    const h = data.hourly;
                    clearContainer();

                    const container = document.getElementById('cards-container');
                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                    const hojeStr = new Date().toISOString().split('T')[0];

                    d.time.forEach((dateStr, idx) => {
                        // ✅ corrigido: cria Date local sem aplicar UTC
                        const [year, month, day] = dateStr.split("-").map(Number);
                        const dateObj = new Date(year, month - 1, day);

                        const nome = dayNames[dateObj.getDay()];
                        const dataFmt = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                        const isToday = dateStr === hojeStr;

                        const tMin = d.temperature_2m_min[idx];
                        const tMax = d.temperature_2m_max[idx];
                        const chuva = d.precipitation_sum[idx];
                        const vento = d.wind_speed_10m_max[idx];
                        const rajada = d.wind_gusts_10m_max[idx];
                        const umidMax = d.relative_humidity_2m_max[idx];
                        const umidMin = d.relative_humidity_2m_min[idx];
                        const nascer = new Date(d.sunrise[idx]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const por = new Date(d.sunset[idx]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        // filtrar horas desse dia
                        const dailyHours = [];
                        const dailyCodes = [];
                        h.time.forEach((t, i) => {
                            if (t.startsWith(dateStr)) {
                                dailyHours.push(t);
                                dailyCodes.push(h.weather_code[i]);
                            }
                        });

                        // ⚡ novo: detectar trovoadas
                        const riscoTrovoadas = dailyCodes.some(c => [95, 96, 99].includes(c));

                        const card = document.createElement('div');
                        card.classList.add('card');
                        card.setAttribute('data-index', idx);
                        card.innerHTML = `
                        <p class="dia-data">${nome}, ${dataFmt}</p>
                        <div class="metricas-linha">
                            <div class="chuva"><span>Chuva (mm)</span><span>${chuva.toFixed(1)}</span></div>
                            <div class="temp"><span>Temperatura (°C)</span><span>${tMin.toFixed(0)} a ${tMax.toFixed(0)}</span></div>
                            <div class="vento"><span>Vento (km/h)</span><span>${Math.round(vento)}</span></div>
                            <div class="rajadas"><span>Rajadas (km/h)</span><span>${Math.round(rajada)}</span></div>
                            <div class="umid"><span>Umidade (%) </span><span>${umidMin} a ${umidMax}</span></div>
                            <div class="sol"><span>Sol</span><span>${nascer} / ${por}</span></div>
                        </div>
                        ${riscoTrovoadas ? `<p class="alerta">Alerta de trovoadas!</p>` : ""}
                        ${chuva > 15 ? `<p class="alerta">Alerta de acumulado de chuva!</p>` : ""}
                        ${umidMin < 30 ? `<p class="alerta">Alerta de baixa umidade do ar!</p>` : ""}
                    `;

                        const details = createWeatherMenu(dailyHours, dailyCodes, isToday);
                        card.appendChild(details);

                        card.addEventListener('click', () => {
                            const isOpen = details.classList.contains('open');
                            document.querySelectorAll('.weather-details.open').forEach(o => collapseDetails(o));

                            if (isOpen) {
                                collapseDetails(details);
                                history.back();
                            } else {
                                openDetails(details, card);
                                history.pushState({ openIndex: idx }, '', `#dia${idx}`);
                            }
                        });

                        container.appendChild(card);
                    });

                    window.onpopstate = (event) => {
                        document.querySelectorAll('.weather-details.open').forEach(o => collapseDetails(o));
                        if (event.state?.openIndex != null) {
                            const card = document.querySelector(`.card[data-index="${event.state.openIndex}"]`);
                            if (card) {
                                const details = card.querySelector('.weather-details');
                                openDetails(details, card);
                            }
                        }
                    };
                });
        }

        function fetchLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let nome = "Localização desconhecida";
                    if (data?.address) {
                        const a = data.address;
                        nome = `${a.city || a.town || a.village || ""}${a.state ? ", " + a.state : ""}${a.country ? ", " + a.country : ""}`;
                    }
                    document.getElementById('location').textContent = "📌 " + nome;
                });
        }

        function searchCity(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}&accept-language=pt`;
            fetch(url)
                .then(r => r.json())
                .then(d => {
                    if (d.length > 0) {
                        const lat = d[0].lat, lon = d[0].lon;
                        fetchLocationName(lat, lon);
                        fetchWeather(lat, lon);
                        document.getElementById('city-input').value = ""; // 🧹 limpa o campo após a busca
                    } else alert("Cidade não encontrada.");
                });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lon } = pos.coords;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            }, () => {
                const lat = -9.7811, lon = -36.0936;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            });
        }

        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('city-input').value.trim();
            if (city) searchCity(city);
        });
    </script>

</body>

</html>