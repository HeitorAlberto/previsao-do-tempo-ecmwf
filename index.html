<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsão do Tempo - ECMWF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap');

        body {
            font-family: "Ubuntu", sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            font-size: 28px;
        }

        #search-box {
            margin-bottom: 15px;
            text-align: center;
        }

        #search-box input {
            font-size: 22px;
            width: 450px;
            padding: 8px;
            font-family: "Ubuntu", sans-serif;
        }

        #search-box button {
            font-size: 22px;
            margin-left: 5px;
            padding: 8px 12px;
            font-family: "Ubuntu", sans-serif;
        }

        #location {
            margin: 30px 0;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 14px 16px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-sizing: border-box;
            width: 100%;
        }

        .dia-data {
            font-weight: bold;
            font-size: 22px;
            text-align: left;
            margin: 0px 0px 10px 0px;
        }

        .metricas-linha {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 20px;
            text-align: center;
        }

        .metricas-linha span {
            display: inline-block;
            border-radius: 5px;
            padding: 5px 6px;
            font-weight: 500;
        }

        .chuva {
            background-color: #b9e3ff;
        }

        .temp {
            background-color: #ff9b6f;
        }

        .vento {
            background-color: #90ff7f;
        }

        .umid {
            background-color: #b9e3ff;
        }

        /* ✅ Agora os detalhes ficam dentro do card */
        .weather-details {
            max-height: 0;
            overflow: hidden;
            background: #fff;
            border-radius: 0 0 8px 8px;
            margin-top: 6px;
            box-sizing: border-box;
        }

        .weather-details.open {
            max-height: 3000px;
            padding: 10px 4px;
        }

        .weather-details p {
            display: flex;
            gap: 20px;
            padding: 8px 10px;
            font-size: 20px;
        }

        .current-hour {
            background-color: #befaff;
            border-radius: 4px;
            padding-left: 5px;
        }

        @media (max-width: 700px) {
            #search-box input {
                font-size: 22px;
                width: 80%;
                padding: 8px;
                margin-bottom: 5px;
                font-family: "Ubuntu", sans-serif;
            }

            .metricas-linha {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .weather-details p {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <h1>Previsão 15 dias - ECMWF (Alta resolução - 9km)</h1>

    <div id="search-box">
        <input type="text" id="city-input" placeholder="Digite a cidade">
        <button id="search-btn">Buscar</button>
    </div>

    <div id="location">Carregando localização...</div>

    <div id="cards-container" class="cards"></div>

    <script>
        const weatherDescriptions = {
            0: "Céu limpo", 1: "Parcialmente nublado", 2: "Muitas nuvens", 3: "Nublado",
            45: "Névoa", 48: "Neblina", 51: "Chuvisco fraco", 53: "Chuvisco moderado",
            55: "Chuvisco forte", 56: "Chuvisco congelante fraco", 57: "Chuvisco congelante forte",
            61: "Chuva fraca", 63: "Chuva moderada", 65: "Chuva forte", 66: "Chuva congelante fraca",
            67: "Chuva congelante forte", 71: "Neve fraca", 73: "Neve moderada", 75: "Neve forte",
            77: "Cristais de gelo", 80: "Pancadas de chuva fraca", 81: "Pancadas de chuva moderada",
            82: "Pancadas de chuva forte", 85: "Pancadas de neve fraca", 86: "Pancadas de neve forte",
            95: "Risco de trovoadas", 96: "Tempestades com granizo", 99: "Tempestades fortes com granizo"
        };

        function clearContainer() {
            document.getElementById('cards-container').innerHTML = '';
        }

        function createWeatherMenu(list, isToday) {
            const div = document.createElement('div');
            div.classList.add('weather-details');

            const currentHour = new Date().getHours();
            list.sort((a, b) => a.hora - b.hora);

            for (let h = 0; h < 24; h++) {
                const found = list.find(item => item.hora === h);
                const desc = found ? (weatherDescriptions[found.code] || `Código ${found.code}`) : "Sem dados";
                const p = document.createElement('p');
                p.innerHTML = `<span><b>${String(h).padStart(2, '0')}:00</b></span><span style="color: gray;">${desc}</span>`;
                if (isToday && h === currentHour) p.classList.add('current-hour');
                div.appendChild(p);
            }
            return div;
        }

        function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,wind_gusts_10m,weathercode&models=ecmwf_ifs&timezone=auto&forecast_days=14`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (!data?.hourly?.time) return;

                    const { time, temperature_2m, precipitation, wind_speed_10m, wind_gusts_10m, relative_humidity_2m, weathercode } = data.hourly;
                    const dailyData = {};

                    for (let i = 0; i < time.length; i++) {
                        const date = new Date(time[i]);
                        const key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;

                        if (!dailyData[key]) {
                            dailyData[key] = {
                                tMin: temperature_2m[i],
                                tMax: temperature_2m[i],
                                chuva: 0,
                                umidMin: relative_humidity_2m[i],
                                umidMax: relative_humidity_2m[i],
                                vento: wind_speed_10m[i],
                                rajada: wind_gusts_10m[i],
                                weatherHours: []
                            };
                        }

                        const d = dailyData[key];
                        d.tMin = Math.min(d.tMin, temperature_2m[i]);
                        d.tMax = Math.max(d.tMax, temperature_2m[i]);
                        d.chuva += precipitation[i] || 0;
                        d.umidMin = Math.min(d.umidMin, relative_humidity_2m[i]);
                        d.umidMax = Math.max(d.umidMax, relative_humidity_2m[i]);
                        d.vento = Math.max(d.vento, wind_speed_10m[i]);
                        d.rajada = Math.max(d.rajada, wind_gusts_10m[i]);
                        d.weatherHours.push({ hora: date.getHours(), code: weathercode[i] });
                    }

                    clearContainer();

                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                    const sortedKeys = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
                    const hojeStr = `${new Date().getFullYear()}-${new Date().getMonth() + 1}-${new Date().getDate()}`;
                    const container = document.getElementById('cards-container');

                    sortedKeys.forEach(key => {
                        const { tMin, tMax, chuva, umidMin, umidMax, vento, rajada, weatherHours } = dailyData[key];
                        const [y, m, d] = key.split('-');
                        const dateObj = new Date(y, m - 1, d);
                        const nome = dayNames[dateObj.getDay()];
                        const dataFmt = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                        const isToday = key === hojeStr;

                        const card = document.createElement('div');
                        card.classList.add('card');
                        card.innerHTML = `
              <p class="dia-data">${nome}, ${dataFmt}</p>
              <div class="metricas-linha">
                <span class="chuva">${chuva.toFixed(1)} mm</span>
                <span class="temp">${tMin.toFixed(0)} - ${tMax.toFixed(0)} (°C)</span>
                <span class="vento">${Math.round(vento)} / ${Math.round(rajada)} (km/h)</span>
                <span class="umid">${Math.round(umidMin)} - ${Math.round(umidMax)} (%)</span>
              </div>
            `;

                        const details = createWeatherMenu(weatherHours, isToday);
                        card.appendChild(details); // ✅ agora dentro do card
                        card.addEventListener('click', () => details.classList.toggle('open'));

                        container.appendChild(card);
                    });
                });
        }

        function fetchLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let nome = "Localização desconhecida";
                    if (data?.address) {
                        const a = data.address;
                        nome = `${a.city || a.town || a.village || ""}${a.state ? ", " + a.state : ""}${a.country ? ", " + a.country : ""}`;
                    }
                    document.getElementById('location').textContent = "📌 " + nome;
                });
        }

        function searchCity(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}&accept-language=pt`;
            fetch(url)
                .then(r => r.json())
                .then(d => {
                    if (d.length > 0) {
                        const lat = d[0].lat, lon = d[0].lon;
                        fetchLocationName(lat, lon);
                        fetchWeather(lat, lon);
                    } else alert("Cidade não encontrada.");
                });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lon } = pos.coords;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            }, () => {
                const lat = -9.7811, lon = -36.0936;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            });
        }

        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('city-input').value.trim();
            if (city) searchCity(city);
        });
    </script>
</body>

</html>