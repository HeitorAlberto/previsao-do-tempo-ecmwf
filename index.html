<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previs√£o do Tempo</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');

        body {
            font-family: "Inter", sans-serif;
            padding: 20px;
            background-color: #e3e3e3;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            overflow-x: hidden;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            font-size: 28px;
        }

        #search-box {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 600px;
        }

        #search-box input {
            flex: 1;
            font-size: 22px;
            border-radius: 8px;
            border: none;
            padding: 8px;
            text-align: center;
        }

        input:focus {
            outline: none;
            border: none;
            box-shadow: none;
        }

        #search-box button {
            background-color: #282828;
            color: white;
            font-size: 22px;
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
        }

        #location {
            margin: 30px 0;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }

        .cards {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            width: 100%;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 14px 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-sizing: border-box;
            width: 800px;
            max-width: 95%;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dia-data {
            font-weight: bold;
            font-size: 22px;
            text-align: left;
            margin: 0;
        }

        .metricas-linha {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            font-size: 16px;
            text-align: center;
        }

        .metricas-linha>div {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 18px;
            align-items: center;
        }

        .metricas-linha>div span:last-child {
            font-weight: bold;
            font-size: 22px;
        }

        .chuva,
        .temp,
        .vento,
        .rajadas,
        .umid {
            background-color: #ddfaff;
        }

        .alerta {
            font-size: 18px;
            margin-top: 5px;
            text-align: center;
            margin-bottom: 0px;
            font-weight: bolder;
            color: #eb4848;
        }

        .cards-3h-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-top: 10px;
        }

        .cards-3h-container::-webkit-scrollbar {
            display: none;
        }

        .card-3h {
            flex: 0 0 auto;
            min-width: 80px;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 10px 20px;
            text-align: center;
            font-size: 20px;
        }

        .card-3h b {
            display: block;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .card-3h div {
            margin-bottom: 10px;
        }

        .card-3h.atual {
            background: #fff3b0;
            border: 2px solid #d4af37;
        }

        @media (max-width: 920px) {
            body {
                padding: 1px;
            }

            #search-box {
                flex-direction: column;
                width: 85%;
                align-self: center;
            }

            .card {
                width: 95%;
            }

            .card-3h {
                min-width: 70px;
                font-size: 20px;
            }
        }
    </style>
</head>

<body>
    <h1>Previs√£o 16 dias - ECMWF (9 km)</h1>
    <div id="search-box">
        <input type="text" id="city-input" placeholder="Digite a cidade">
        <button id="search-btn">Buscar</button>
    </div>
    <div id="location">Carregando localiza√ß√£o...</div>
    <div id="cards-container" class="cards"></div>

    <script>
        const weatherDescriptions = {
            0: "C√©u limpo", 1: "Algumas nuvens", 2: "Parcialmente nublado", 3: "Nublado",
            45: "N√©voa", 48: "Neblina", 51: "Chuvisco fraco", 53: "Chuvisco moderado",
            55: "Chuvisco forte", 56: "Garoa congelante fraca", 57: "Garoa congelante forte",
            61: "Chuva fraca", 63: "Chuva moderada", 65: "Chuva forte", 66: "Chuva congelante fraca",
            67: "Chuva congelante forte", 71: "Neve fraca", 73: "Neve moderada", 75: "Neve forte",
            77: "Cristais de gelo", 80: "Pancadas de chuva fraca", 81: "Pancadas de chuva moderada",
            82: "Pancadas de chuva forte", 85: "Pancadas de neve fraca", 86: "Pancadas de neve forte",
            95: "Risco de trovoadas", 96: "Tempestades com granizo", 99: "Tempestades fortes com granizo"
        };

        const weatherPriority = {
            tempestade: [95, 96, 99],
            neve: [71, 73, 75, 85, 86, 77],
            chuva: [51, 53, 55, 56, 57, 61, 63, 65, 66, 67, 80, 81, 82],
            neblina: [45, 48],
            nuvens: [1, 2, 3],
            limpo: [0]
        };

        function getPriorityWeatherCode(codes) {
            for (let group of ["tempestade", "neve", "chuva", "neblina", "nuvens", "limpo"]) {
                const found = codes.find(c => weatherPriority[group].includes(c));
                if (found !== undefined) return found;
            }
            return codes[0];
        }

        function clearContainer() {
            document.getElementById('cards-container').innerHTML = '';
        }

        function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code,relative_humidity_2m,precipitation,wind_speed_10m,wind_gusts_10m&models=ecmwf_ifs&forecast_days=14&timezone=auto`;
            fetch(apiUrl).then(res => res.json()).then(data => {
                if (!data?.hourly?.time) return;
                const h = data.hourly;
                clearContainer();

                const dailyData = {};
                h.time.forEach((t, i) => {
                    const dateStr = t.split("T")[0];
                    if (!dailyData[dateStr]) dailyData[dateStr] = [];
                    dailyData[dateStr].push({
                        temp: h.temperature_2m[i],
                        chuva: h.precipitation[i],
                        vento: h.wind_speed_10m[i],
                        rajada: h.wind_gusts_10m[i],
                        umid: h.relative_humidity_2m[i],
                        code: h.weather_code[i],
                        hora: t
                    });
                });

                const container = document.getElementById('cards-container');
                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

                Object.keys(dailyData).forEach(dateStr => {
                    const registros = dailyData[dateStr];
                    const [year, month, day] = dateStr.split("-").map(Number);
                    const dateObj = new Date(year, month - 1, day);
                    const nome = dayNames[dateObj.getDay()];
                    const dataFmt = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}`;

                    const tMin = Math.min(...registros.map(r => r.temp));
                    const tMax = Math.max(...registros.map(r => r.temp));
                    const chuvaTotal = registros.reduce((s, r) => s + r.chuva, 0);
                    const vento = Math.max(...registros.map(r => r.vento));
                    const rajada = Math.max(...registros.map(r => r.rajada));
                    const umidMax = Math.max(...registros.map(r => r.umid));
                    const umidMin = Math.min(...registros.map(r => r.umid));
                    const dailyCodes = registros.map(r => r.code);
                    const riscoTrovoadas = dailyCodes.some(c => weatherPriority.tempestade.includes(c));

                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.innerHTML = `
                <div class="card-header"><p class="dia-data">${nome}, ${dataFmt}</p></div>
                <div class="metricas-linha">
                    <div class="chuva"><span>‚òî Chuva (mm)</span><span>${chuvaTotal.toFixed(1)}</span></div>
                    <div class="temp"><span>üå°Ô∏è Temperatura (¬∞C)</span><span>${tMin.toFixed(0)} a ${tMax.toFixed(0)}</span></div>
                    <div class="vento"><span>üçÉ Vento (km/h)</span><span>${Math.round(vento)}</span></div>
                    <div class="rajadas"><span>üçÉ Rajadas (km/h)</span><span>${Math.round(rajada)}</span></div>
                    <div class="umid"><span>üíß Umidade (%)</span><span>${umidMin} a ${umidMax}</span></div>
                </div>
            `;

                    // === CARDS DE 3 HORAS ===
                    const cards3hContainer = document.createElement('div');
                    cards3hContainer.classList.add('cards-3h-container');

                    const hoje = new Date();
                    const mesmoDia =
                        dateObj.getFullYear() === hoje.getFullYear() &&
                        dateObj.getMonth() === hoje.getMonth() &&
                        dateObj.getDate() === hoje.getDate();

                    let horaAtualIndex = -1;

                    for (let i = 0; i < registros.length; i += 3) {
                        const chunk = registros.slice(i, i + 3);
                        const hora = new Date(chunk[0].hora).getHours();

                        // === NOVO CONTE√öDO: mostra todas as 3 condi√ß√µes ===
                        const condicoes = chunk.map(r => weatherDescriptions[r.code] || "‚Äî");

                        const item = document.createElement('div');
                        item.classList.add('card-3h');
                        item.innerHTML = `
                    <b>${String(hora).padStart(2, '0')}h</b>
                    ${condicoes.map(c => `<div>${c}</div>`).join('')}
                `;
                        cards3hContainer.appendChild(item);

                        // Identifica a hora atual (somente para o dia de hoje)
                        if (mesmoDia) {
                            const diff = Math.abs(hora - hoje.getHours());
                            if (
                                horaAtualIndex === -1 ||
                                diff < Math.abs(new Date(registros[horaAtualIndex * 3]?.hora).getHours() - hoje.getHours())
                            ) {
                                horaAtualIndex = i / 3;
                            }
                        }
                    }

                    card.appendChild(cards3hContainer);

                    // === DESTACA E CENTRALIZA ===
                    if (mesmoDia && horaAtualIndex >= 0) {
                        setTimeout(() => {
                            const items = cards3hContainer.querySelectorAll('.card-3h');
                            const atual = items[horaAtualIndex];
                            if (atual) {
                                atual.classList.add('atual');
                                const containerWidth = cards3hContainer.clientWidth;
                                const scrollWidth = cards3hContainer.scrollWidth;
                                const itemLeft = atual.offsetLeft;
                                const itemWidth = atual.offsetWidth;
                                let scrollPos = itemLeft - (containerWidth / 2) + (itemWidth / 2);
                                scrollPos = Math.max(0, Math.min(scrollPos, scrollWidth - containerWidth));
                                cards3hContainer.scrollTo({ left: scrollPos, behavior: 'smooth' });
                            }
                        }, 100);
                    }

                    // === ALERTAS ===
                    if (riscoTrovoadas)
                        card.appendChild(Object.assign(document.createElement('p'), { className: 'alerta', textContent: 'Alerta: Trovoadas!' }));
                    if (chuvaTotal > 15)
                        card.appendChild(Object.assign(document.createElement('p'), { className: 'alerta', textContent: 'Alerta: Chuva forte!' }));
                    if (umidMin < 30)
                        card.appendChild(Object.assign(document.createElement('p'), { className: 'alerta', textContent: 'Alerta: Baixa umidade do ar!' }));
                    if (rajada >= 40)
                        card.appendChild(Object.assign(document.createElement('p'), { className: 'alerta', textContent: 'Alerta: Rajadas de vento!' }));

                    container.appendChild(card);
                });
            });
        }

        function fetchLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`;
            fetch(url).then(res => res.json()).then(data => {
                let nome = "Localiza√ß√£o desconhecida";
                if (data?.address) {
                    const a = data.address;
                    nome = `${a.city || a.town || a.village || ""}${a.state ? ", " + a.state : ""}${a.country ? ", " + a.country : ""}`;
                }
                document.getElementById('location').textContent = "üìå " + nome;
            });
        }

        function searchCity(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}&accept-language=pt`;
            fetch(url).then(r => r.json()).then(d => {
                if (d.length > 0) {
                    const lat = d[0].lat, lon = d[0].lon;
                    fetchLocationName(lat, lon);
                    fetchWeather(lat, lon);
                    document.getElementById('city-input').value = "";
                } else alert("Cidade n√£o encontrada.");
            });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lon } = pos.coords;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            }, () => {
                const lat = -9.7811, lon = -36.0936;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            });
        }

        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('city-input').value.trim();
            if (city) searchCity(city);
        });
    </script>

</body>

</html>