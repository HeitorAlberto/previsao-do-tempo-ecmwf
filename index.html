<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsão do Tempo - ECMWF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap');

        body {
            font-family: "Ubuntu", sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            font-size: 28px;
        }

        h2 {
            margin-top: 20px;
            text-align: center;
            font-size: 22px;
        }

        #search-box {
            margin-bottom: 15px;
            text-align: center;
        }

        #search-box input {
            font-size: 22px;
            width: 450px;
            padding: 8px;
            font-family: "Ubuntu", sans-serif;
        }

        #search-box button {
            font-size: 22px;
            margin-left: 5px;
            padding: 8px 12px;
            font-family: "Ubuntu", sans-serif;
        }

        #location {
            margin: 30px 0;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }

        .metricas-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .metrica h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        /* Cards */
        .cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 14px 16px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 700px;
            /* desktop maior */
            min-width: 250px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .info-group {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            justify-content: flex-end;
        }

        .card p {
            margin: 0;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 22px;
        }

        .dia-data {
            font-weight: bolder;
            font-size: 22px;
            /* maior destaque para dia/data */
        }

        /* Cores das métricas */
        .chuva {
            background-color: #386dff;
            color: white;
            font-weight: 500;
        }

        .temp {
            background-color: #ff753a;
            color: white;
            font-weight: 500;
        }

        .umid {
            background-color: #386dff;
            color: white;
            font-weight: 500;
        }

        .vento {
            background-color: #1cd300;
            color: white;
            font-weight: 500;
        }

        .trovoadas {
            background-color: #ffce6b;
            color: black;
            font-weight: 500;
        }

        /* Responsividade celular */
        @media (max-width: 600px) {

            body {
                padding: 0px;
                margin: 0px;
            }

            #search-box input {border-radius: 10px; padding: 14px;}

            #search-box button {width: 120px; border-radius: 10px;}

            .card {
                width: 100%;
                /* ocupa toda a largura do body */
                max-width: none;
                padding: 12px 14px;
                flex-direction: row;
            }

            .card p {
                font-size: 22px;
                padding: 6px 8px;
            }

            .dia-data {
                font-size: 18px;
            }

            #search-box input {
                width: 90%;
                font-size: 16px;
                text-align: center;
            }

            #search-box button {
                margin-top: 10px;
                font-size: 16px;
                padding: 8px 12px;
            }

            .metricas-grid {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <h1>Previsão 15 dias - ECMWF</h1>

    <div id="search-box">
        <input type="text" id="city-input" placeholder="Digite a cidade">
        <button id="search-btn">Buscar</button>
    </div>

    <div id="location">Carregando localização...</div>

    <div class="metricas-grid">
        <div class="metrica">
            <h2>Chuva (mm) e Temperatura (°C)</h2>
            <div id="chuva" class="cards"></div>
        </div>

        <div class="metrica">
            <h2>Umidade (%) e Vento/Rajadas (km/h)</h2>
            <div id="umidade" class="cards"></div>
        </div>

        <div class="metrica">
            <h2>Chance de Trovoadas</h2>
            <div id="trovoadas" class="cards"></div>
        </div>
    </div>

    <script>
        function clearIfExists(id) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        }

        function getThunderRisk(cape) {
            if (cape == null) return "—";
            if (cape < 1000) return "sem chance";
            if (cape < 2000) return "trovoadas isoladas";
            if (cape < 3000) return "Trovoadas fortes";
            return "trovoadas intensas";
        }

        function updateThunderCards(dailyData) {
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const sortedKeys = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
            const thunderDiv = document.getElementById('trovoadas');
            thunderDiv.innerHTML = '';

            sortedKeys.forEach(key => {
                const [y, m, d] = key.split('-');
                const dateObj = new Date(y, m - 1, d);
                const dayName = dayNames[dateObj.getDay()];
                const dateFmt = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                const cape = dailyData[key].capeMax || 0;
                const risk = getThunderRisk(cape);

                const card = document.createElement('div');
                card.classList.add('card');
                card.innerHTML = `
                    <p class="dia-data">${dayName}, ${dateFmt}</p>
                    <div class="info-group">
                        <p class="trovoadas">${risk}</p>
                    </div>
                `;
                thunderDiv.appendChild(card);
            });
        }

        function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,wind_gusts_10m,cape&models=ecmwf_ifs&timezone=auto&forecast_days=15`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (!data?.hourly?.time) return;

                    const { time, temperature_2m, precipitation, wind_speed_10m, wind_gusts_10m, relative_humidity_2m, cape } = data.hourly;
                    const dailyData = {};

                    for (let i = 0; i < time.length; i++) {
                        const date = new Date(time[i]);
                        const key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                        if (!dailyData[key]) {
                            dailyData[key] = {
                                tMin: temperature_2m[i],
                                tMax: temperature_2m[i],
                                chuva: precipitation[i] || 0,
                                umidMin: relative_humidity_2m[i],
                                umidMax: relative_humidity_2m[i],
                                vento: wind_speed_10m[i],
                                rajada: wind_gusts_10m[i],
                                capeMax: cape[i] || 0
                            };
                        } else {
                            const d = dailyData[key];
                            d.tMin = Math.min(d.tMin, temperature_2m[i]);
                            d.tMax = Math.max(d.tMax, temperature_2m[i]);
                            d.chuva += precipitation[i] || 0;
                            d.umidMin = Math.min(d.umidMin, relative_humidity_2m[i]);
                            d.umidMax = Math.max(d.umidMax, relative_humidity_2m[i]);
                            d.vento = Math.max(d.vento, wind_speed_10m[i]);
                            d.rajada = Math.max(d.rajada, wind_gusts_10m[i]);
                            d.capeMax = Math.max(d.capeMax, cape[i] || 0);
                        }
                    }

                    clearIfExists('chuva');
                    clearIfExists('umidade');

                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                    const sortedKeys = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));

                    const chuvaDiv = document.getElementById('chuva');
                    const umidDiv = document.getElementById('umidade');

                    sortedKeys.forEach(key => {
                        const [y, m, d] = key.split('-');
                        const dateObj = new Date(y, m - 1, d);
                        const nome = dayNames[dateObj.getDay()];
                        const dataFmt = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                        const val = dailyData[key];

                        const card1 = document.createElement('div');
                        card1.classList.add('card');
                        card1.innerHTML = `
                            <p class="dia-data">${nome}, ${dataFmt}</p>
                            <div class="info-group">
                                <p class="chuva">${val.chuva.toFixed(1)} mm</p>
                                <p class="temp">${Math.round(val.tMin)} - ${Math.round(val.tMax)}</p>
                            </div>
                        `;
                        chuvaDiv.appendChild(card1);

                        const card2 = document.createElement('div');
                        card2.classList.add('card');
                        card2.innerHTML = `
                            <p class="dia-data">${nome}, ${dataFmt}</p>
                            <div class="info-group">
                                <p class="umid">${Math.round(val.umidMin)} - ${Math.round(val.umidMax)}</p>
                                <p class="vento">${Math.round(val.vento)} / ${Math.round(val.rajada)}</p>
                            </div>
                        `;
                        umidDiv.appendChild(card2);
                    });

                    // Atualiza os cards de trovoadas
                    updateThunderCards(dailyData);
                });
        }

        function fetchLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let nome = "Localização desconhecida";
                    if (data?.address) {
                        const a = data.address;
                        nome = `${a.city || a.town || a.village || ""}${a.state ? ", " + a.state : ""}${a.country ? ", " + a.country : ""}`;
                    }
                    document.getElementById('location').textContent = "📌 " + nome;
                });
        }

        function searchCity(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}&accept-language=pt`;
            fetch(url)
                .then(r => r.json())
                .then(d => {
                    if (d.length > 0) {
                        const lat = d[0].lat, lon = d[0].lon;
                        fetchLocationName(lat, lon);
                        fetchWeather(lat, lon);
                    } else alert("Cidade não encontrada.");
                });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lon } = pos.coords;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            }, () => {
                const lat = -9.7811, lon = -36.0936;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            });
        }

        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('city-input').value.trim();
            if (city) searchCity(city);
        });
    </script>
</body>

</html>