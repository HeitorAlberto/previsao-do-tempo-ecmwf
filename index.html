<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previs√£o do Tempo - ECMWF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap');

        body {
            font-family: "Ubuntu", sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        h1,
        h2 {
            margin-top: 20px;
            text-align: center;
            font-size: 18px;
        }

        #search-box {
            margin-bottom: 15px;
            text-align: center;
        }

        #search-box input {
            font-size: 16px;
            width: 250px;
            padding: 8px;
            font-family: "Ubuntu", sans-serif;
        }

        #search-box button {
            font-size: 16px;
            margin-left: 5px;
            padding: 8px 12px;
            font-family: "Ubuntu", sans-serif;
        }

        #location {
            margin: 30px 0;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            background-color: #cfcfcf;
            padding: 10px;
        }

        .metricas-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .metrica h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        /* Cards */
        .cards {
            display: flex;
            flex-direction: column; /* um card por linha */
            gap: 12px;
            width: 100%;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: row; /* mant√©m horizontal sempre */
            justify-content: space-between;
            align-items: center;
            width: 100%; /* ocupa toda largura do container */
            max-width: 500px; /* desktop */
            min-width: 250px; /* celular */
            margin: 0 auto;
            box-sizing: border-box;
        }

        .info-group {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap; /* n√£o quebra os elementos */
            justify-content: flex-end;
        }

        .card p {
            margin: 0;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 14px;
        }

        .dia-data {
            font-weight: 800;
        }

        /* Cores das m√©tricas */
        .chuva {
            background-color: #c3e1ff;
        }

        .temp {
            background-color: #ffe5cb;
        }

        .umid {
            background-color: #c3e1ff;
        }

        .vento {
            background-color: #c4ffd8;
        }

        /* Responsividade */
        @media (max-width: 600px) {
            .card {
                width: 95%;
                max-width: none;
                padding: 10px;
            }
            .card p {
                font-size: 14px; /* mant√©m leg√≠vel */
            }
            #search-box input {
                width: 80%;
            }
        }
    </style>
</head>

<body>

    <h1>Previs√£o 15 dias - ECMWF</h1>

    <div id="search-box">
        <input type="text" id="city-input" placeholder="Digite cidade, estado ou pa√≠s">
        <button id="search-btn">Buscar</button>
    </div>

    <div id="location">Carregando localiza√ß√£o...</div>

    <div class="metricas-grid">
        <div class="metrica">
            <h2>Chuva e Temperatura</h2>
            <div id="chuva" class="cards"></div>
        </div>

        <div class="metrica">
            <h2>Umidade (%) e Vento/Rajadas (km/h)</h2>
            <div id="umidade" class="cards"></div>
        </div>
    </div>

    <script>
        function clearIfExists(id) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        }

        function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,wind_gusts_10m,cape&models=ecmwf_ifs&timezone=auto&forecast_days=14`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (!data?.hourly?.time) return;

                    const { time, temperature_2m, precipitation, wind_speed_10m, wind_gusts_10m, relative_humidity_2m } = data.hourly;
                    const dailyData = {};

                    for (let i = 0; i < time.length; i++) {
                        const date = new Date(time[i]);
                        const key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                        if (!dailyData[key]) {
                            dailyData[key] = {
                                tMin: temperature_2m[i],
                                tMax: temperature_2m[i],
                                chuva: precipitation[i] || 0,
                                umidMin: relative_humidity_2m[i],
                                umidMax: relative_humidity_2m[i],
                                vento: wind_speed_10m[i],
                                rajada: wind_gusts_10m[i]
                            };
                        } else {
                            const d = dailyData[key];
                            d.tMin = Math.min(d.tMin, temperature_2m[i]);
                            d.tMax = Math.max(d.tMax, temperature_2m[i]);
                            d.chuva += precipitation[i] || 0;
                            d.umidMin = Math.min(d.umidMin, relative_humidity_2m[i]);
                            d.umidMax = Math.max(d.umidMax, relative_humidity_2m[i]);
                            d.vento = Math.max(d.vento, wind_speed_10m[i]);
                            d.rajada = Math.max(d.rajada, wind_gusts_10m[i]);
                        }
                    }

                    clearIfExists('chuva');
                    clearIfExists('umidade');

                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                    const sortedKeys = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));

                    const chuvaDiv = document.getElementById('chuva');
                    const umidDiv = document.getElementById('umidade');

                    sortedKeys.forEach(key => {
                        const [y, m, d] = key.split('-');
                        const dateObj = new Date(y, m - 1, d);
                        const nome = dayNames[dateObj.getDay()];
                        const dataFmt = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                        const val = dailyData[key];

                        const chuva = `${Math.round(val.chuva)} mm`;
                        const temp = `${Math.round(val.tMin)} a ${Math.round(val.tMax)}`;
                        const umid = `${Math.round(val.umidMin)} a ${Math.round(val.umidMax)}`;
                        const vento = `${Math.round(val.vento)} / ${Math.round(val.rajada)}`;

                        const card1 = document.createElement('div');
                        card1.classList.add('card');
                        card1.innerHTML = `
                            <p class="dia-data">${nome}, ${dataFmt}</p>
                            <div class="info-group">
                                <p class="chuva">${chuva}</p>
                                <p class="temp">${temp}</p>
                            </div>
                        `;
                        chuvaDiv.appendChild(card1);

                        const card2 = document.createElement('div');
                        card2.classList.add('card');
                        card2.innerHTML = `
                            <p class="dia-data">${nome}, ${dataFmt}</p>
                            <div class="info-group">
                                <p class="umid">${umid}</p>
                                <p class="vento">${vento}</p>
                            </div>
                        `;
                        umidDiv.appendChild(card2);
                    });
                });
        }

        function fetchLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let nome = "Localiza√ß√£o desconhecida";
                    if (data?.address) {
                        const a = data.address;
                        nome = `${a.city || a.town || a.village || ""}${a.state ? ", " + a.state : ""}${a.country ? ", " + a.country : ""}`;
                    }
                    document.getElementById('location').textContent = "üìå " + nome;
                });
        }

        function searchCity(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}&accept-language=pt`;
            fetch(url)
                .then(r => r.json())
                .then(d => {
                    if (d.length > 0) {
                        const lat = d[0].lat, lon = d[0].lon;
                        fetchLocationName(lat, lon);
                        fetchWeather(lat, lon);
                    } else alert("Cidade n√£o encontrada.");
                });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lon } = pos.coords;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            }, () => {
                const lat = -9.7811, lon = -36.0936;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            });
        }

        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('city-input').value.trim();
            if (city) searchCity(city);
        });
    </script>
</body>
</html>
