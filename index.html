<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previs√£o do Tempo - ECMWF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap');

        body {
            font-family: "Ubuntu", sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        h1,
        h2 {
            margin-top: 20px;
            text-align: center;
        }

        .cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .card {
            padding: 10px;
            background-color: white;
            text-align: left;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }

        .bold {
            font-weight: bold;
        }

        #location {
            margin-top: 50px;
            margin-bottom: 50px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            background-color: #cfcfcf;
            padding: 10px;
        }

        #search-box {
            margin-bottom: 15px;
            text-align: center;
            
        }

        #search-box input {
            padding: 5px;
            font-size: 1em;
            width: 250px;
            font-family: "Ubuntu", sans-serif;
        }

        #search-box button {
            padding: 5px 10px;
            font-size: 1em;
            margin-left: 5px;
            font-family: "Ubuntu", sans-serif;
        }

        /* GRID das m√©tricas (2 colunas no desktop, 1 no mobile) */
        .metricas-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .metrica h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        /* Responsividade */
        @media (max-width: 700px) {
            #search-box button {
                margin-top: 8px;
                width: 150px;
            }

            .cards {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .metricas-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 450px) {
            .card span {
                font-size: 1.2rem;
            }

            .cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>

<body>

    <h1>Previs√£o 15 dias - ECMWF</h1>

    <div id="search-box">
        <input type="text" id="city-input" placeholder="Digite cidade, estado ou pa√≠s">
        <button id="search-btn">Buscar</button>
    </div>

    <div id="location">Carregando localiza√ß√£o...</div>

    <!-- GRID DE M√âTRICAS -->
    <div class="metricas-grid">
        <div class="metrica">
            <h2>Chuva (mm)</h2>
            <div id="chuva" class="cards"></div>
        </div>

        <div class="metrica">
            <h2>Temperatura (¬∞C)</h2>
            <div id="temperatura" class="cards"></div>
        </div>

        <div class="metrica">
            <h2>Umidade do ar (%)</h2>
            <div id="umidade" class="cards"></div>
        </div>

        <div class="metrica">
            <h2>Vento e Rajadas (km/h)</h2>
            <div id="vento" class="cards"></div>
        </div>

        <div class="metrica">
            <h2>Risco de trovoadas</h2>
            <div id="thunder" class="cards"></div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para determinar descri√ß√£o de trovoadas baseada no CAPE
        function getThunderDescription(cape) {
            if (cape < 1000) return "sem risco";
            if (cape < 2000) return "Trovoadas";
            return "Trovoadas fortes";
        }

        // Buscar previs√£o do tempo (dados hor√°rios)
        function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,dew_point_2m,apparent_temperature,precipitation,rain,showers,snowfall,runoff,visibility,weather_code,et0_fao_evapotranspiration,potential_evapotranspiration,vapour_pressure_deficit,sunshine_duration,cloud_cover_high,cloud_cover_mid,cloud_cover_low,cloud_cover,surface_pressure,pressure_msl,wind_speed_10m,wind_speed_100m,wind_speed_200m,wind_direction_10m,wind_direction_100m,wind_direction_200m,wind_gusts_10m,cape,total_column_integrated_water_vapour,convective_inhibition,soil_moisture_100_to_255cm,soil_moisture_28_to_100cm,soil_moisture_7_to_28cm,soil_moisture_0_to_7cm,soil_temperature_100_to_255cm,soil_temperature_28_to_100cm,soil_temperature_7_to_28cm,soil_temperature_0_to_7cm,surface_temperature&models=ecmwf_ifs&timezone=auto&forecast_days=15`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    const times = data.hourly.time;
                    const temperatures = data.hourly.temperature_2m;
                    const precipitations = data.hourly.precipitation;
                    const windSpeeds = data.hourly.wind_speed_10m;
                    const windGusts = data.hourly.wind_gusts_10m;
                    const humidity = data.hourly.relative_humidity_2m;
                    const cape = data.hourly.cape;

                    const dailyData = {};

                    for (let i = 0; i < times.length; i++) {
                        const date = new Date(times[i]);
                        const dayKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;

                        if (!dailyData[dayKey]) {
                            dailyData[dayKey] = {
                                tempMin: temperatures[i],
                                tempMax: temperatures[i],
                                precipSum: precipitations[i],
                                windMax: windSpeeds[i],
                                gustMax: windGusts[i],
                                humMin: humidity[i],
                                humMax: humidity[i],
                                capeMax: cape[i]
                            };
                        } else {
                            const d = dailyData[dayKey];
                            d.tempMin = Math.min(d.tempMin, temperatures[i]);
                            d.tempMax = Math.max(d.tempMax, temperatures[i]);
                            d.precipSum += precipitations[i];
                            d.windMax = Math.max(d.windMax, windSpeeds[i]);
                            d.gustMax = Math.max(d.gustMax, windGusts[i]);
                            d.humMin = Math.min(d.humMin, humidity[i]);
                            d.humMax = Math.max(d.humMax, humidity[i]);
                            d.capeMax = Math.max(d.capeMax, cape[i]);
                        }
                    }

                    document.getElementById('chuva').innerHTML = '';
                    document.getElementById('temperatura').innerHTML = '';
                    document.getElementById('vento').innerHTML = '';
                    document.getElementById('umidade').innerHTML = '';
                    document.getElementById('thunder').innerHTML = '';

                    const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];

                    Object.keys(dailyData).forEach(dayKey => {
                        const [year, month, day] = dayKey.split('-');
                        const dateObj = new Date(year, month - 1, day);
                        const dayName = dayNames[dateObj.getDay()];
                        const formattedDate = `${dateObj.getDate()}/${dateObj.getMonth() + 1}`;
                        const d = dailyData[dayKey];

                        function createCard(label, value) {
                            const card = document.createElement('div');
                            card.classList.add('card');
                            card.innerHTML = `<span class="bold">${label}</span><span>${value}</span>`;
                            return card;
                        }

                        document.getElementById('chuva').appendChild(createCard(`${dayName}, ${formattedDate}`, `${Math.round(d.precipSum)} mm`));
                        document.getElementById('temperatura').appendChild(createCard(`${dayName}, ${formattedDate}`, `${Math.round(d.tempMin)} a ${Math.round(d.tempMax)}`));
                        document.getElementById('umidade').appendChild(createCard(`${dayName}, ${formattedDate}`, `${Math.round(d.humMin)} a ${Math.round(d.humMax)}`));
                        document.getElementById('vento').appendChild(createCard(`${dayName}, ${formattedDate}`, `${Math.round(d.windMax)} e ${Math.round(d.gustMax)}`));
                        document.getElementById('thunder').appendChild(createCard(`${dayName}, ${formattedDate}`, getThunderDescription(d.capeMax)));
                    });
                })
                .catch(err => console.error("Erro ao buscar dados:", err));
        }

        // Buscar localiza√ß√£o pelo Nominatim
        function fetchLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let name = "Localiza√ß√£o desconhecida";
                    if (data.address) {
                        const city = data.address.city || data.address.town || data.address.village || "";
                        const state = data.address.state || "";
                        const country = data.address.country || "";
                        name = city ? city : "";
                        if (state) name += name ? `, ${state}` : state;
                        if (country) name += name ? `, ${country}` : country;
                    }
                    document.getElementById('location').textContent = "üìå " + name;
                })
                .catch(err => {
                    console.error("Erro ao buscar localiza√ß√£o:", err);
                    document.getElementById('location').textContent = "Localiza√ß√£o desconhecida";
                });
        }

        // Buscar cidade pelo Nominatim
        function searchCity(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}&accept-language=pt`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = data[0].lat;
                        const lon = data[0].lon;
                        fetchLocationName(lat, lon);
                        fetchWeather(lat, lon);
                    } else {
                        alert("Cidade n√£o encontrada.");
                    }
                })
                .catch(err => console.error("Erro na busca da cidade:", err));
        }

        // Geolocaliza√ß√£o autom√°tica
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            }, error => {
                console.error("Geolocaliza√ß√£o falhou:", error);
                const lat = -9.7811;
                const lon = -36.0936;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            });
        } else {
            console.error("Geolocaliza√ß√£o n√£o suportada");
            const lat = -9.7811;
            const lon = -36.0936;
            fetchLocationName(lat, lon);
            fetchWeather(lat, lon);
        }

        // Bot√£o de busca
        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('city-input').value.trim();
            if (city) searchCity(city);
        });
    </script>

</body>
</html>
