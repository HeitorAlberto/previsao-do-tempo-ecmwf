<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Previs√£o do Tempo</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        padding: 20px;
        background-color: #e3e3e3;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        overflow-x: hidden;
      }
      h1 {
        margin-top: 20px;
        text-align: center;
        font-size: 28px;
      }
      #search-box {
        display: flex;
        gap: 5px;
        justify-content: center;
        margin-bottom: 15px;
        width: 100%;
        max-width: 600px;
      }
      #search-box input {
        flex: 1;
        font-size: 22px;
        border-radius: 8px;
        border: none;
        padding: 8px;
        text-align: center;
      }
      input:focus {
        outline: none;
        border: none;
        box-shadow: none;
      }
      #search-box button {
        background-color: #282828;
        color: white;
        font-size: 22px;
        border-radius: 8px;
        padding: 8px 14px;
        cursor: pointer;
      }
      #location {
        margin: 30px 0;
        font-size: 22px;
        font-weight: bold;
        text-align: center;
        padding: 10px;
      }
      .cards {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
        width: 100%;
      }
      .card {
        background-color: white;
        border-radius: 8px;
        padding: 14px 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-sizing: border-box;
        width: 800px;
        max-width: 95%;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0px 0px 0px;
      }
      .dia-data {
        font-weight: bold;
        font-size: 22px;
        text-align: left;
        margin: 0;
      }
      .metricas-linha {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0px;
        font-size: 16px;
        text-align: center;
      }
      .metricas-linha > div {
        display: flex;
        justify-content: space-between;
        padding: 20px 0px;
        font-size: 18px;
        align-items: center;
      }
      .metricas-linha > div span:last-child {
        font-weight: bold;
        font-size: 22px;
      }
      .chuva,
      .temp,
      .vento,
      .rajadas,
      .umid {
        border-bottom: 1px solid lightgray;
      }
      .alerta {
        font-size: 18px;
        margin-top: 5px;
        text-align: center;
        margin-bottom: 0px;
        font-weight: bolder;
        color: #eb4848;
      }
      .cards-3h-container {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 10px 0 10px 12px;
        margin-top: 10px;
      }
      .cards-3h-container::-webkit-scrollbar {
        display: none;
      }
      .card-3h {
        flex: 0 0 auto;
        min-width: 80px;
        background: #f5f5f5;
        border-radius: 8px;
        padding: 10px 20px;
        text-align: center;
        font-size: 20px;
      }
      .card-3h b {
        display: block;
        font-size: 16px;
        margin-bottom: 4px;
      }
      .card-3h div {
        margin-bottom: 10px;
      }
      .card-3h.atual {
        background: #f5f5f5;
        border: 2px solid #000000;
      }
      @media (max-width: 920px) {
        body {
          padding: 1px;
        }
        #search-box {
          flex-direction: column;
          width: 85%;
          align-self: center;
        }
        .card {
          width: 95%;
        }
        .card-3h {
          min-width: 70px;
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Previs√£o do Tempo - ECMWF (9 km)</h1>
    <div id="search-box">
      <input type="text" id="city-input" placeholder="Digite a cidade" />
      <button id="search-btn">Buscar</button>
    </div>
    <div id="location">Carregando localiza√ß√£o...</div>
    <div id="cards-container" class="cards"></div>
    <script>
      const weatherDescriptions = {
        0: "C√©u limpo",
        1: "Algumas nuvens",
        2: "Parcialmente nublado",
        3: "Nublado",
        45: "N√©voa",
        48: "Neblina",
        51: "Chuvisco fraco",
        53: "Chuvisco moderado",
        55: "Chuvisco forte",
        61: "Chuva fraca",
        63: "Chuva moderada",
        65: "Chuva forte",
        80: "Pancadas de chuva fraca",
        81: "Pancadas de chuva moderada",
        82: "Pancadas de chuva forte",
        95: "Risco de trovoadas",
        96: "Tempestade com granizo",
        99: "Tempestade forte com granizo",
      };
      const prioridade = {
        tempestade: [95, 96, 99],
        chuva: [51, 53, 55, 61, 63, 65, 80, 81, 82],
        neblina: [45, 48],
        nuvens: [1, 2, 3],
        limpo: [0],
      };
      const dias = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
      function limpar() {
        document.getElementById("cards-container").innerHTML = "";
      }
      function fetchTempo(lat, lon) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code,relative_humidity_2m,precipitation,wind_speed_10m,wind_gusts_10m&models=ecmwf_ifs&forecast_days=14&timezone=auto`;
        fetch(url)
          .then((r) => r.json())
          .then((d) => {
            if (!d?.hourly?.time) return;
            limpar();
            const h = d.hourly,
              diario = {};
            h.time.forEach((t, i) => {
              const data = t.split("T")[0];
              (diario[data] ??= []).push({
                temp: h.temperature_2m[i],
                chuva: h.precipitation[i],
                vento: h.wind_speed_10m[i],
                rajada: h.wind_gusts_10m[i],
                umid: h.relative_humidity_2m[i],
                code: h.weather_code[i],
                hora: t,
              });
            });
            const container = document.getElementById("cards-container");
            const agora = new Date();
            for (const [dataStr, regs] of Object.entries(diario)) {
              const [ano, mes, dia] = dataStr.split("-").map(Number);
              const data = new Date(ano, mes - 1, dia);
              const nome = dias[data.getDay()];
              const dataFmt = `${String(dia).padStart(2, "0")}/${String(
                mes
              ).padStart(2, "0")}`;
              const tMin = Math.min(...regs.map((r) => r.temp));
              const tMax = Math.max(...regs.map((r) => r.temp));
              const chuvaTotal = regs.reduce((s, r) => s + r.chuva, 0);
              const vento = Math.max(...regs.map((r) => r.vento));
              const rajada = Math.max(...regs.map((r) => r.rajada));
              const umidMin = Math.min(...regs.map((r) => r.umid));
              const umidMax = Math.max(...regs.map((r) => r.umid));
              const riscoTrovoadas = regs.some((r) =>
                prioridade.tempestade.includes(r.code)
              );
              const card = document.createElement("div");
              card.className = "card";
              card.innerHTML = `
        <div class="card-header"><p class="dia-data">${nome}, ${dataFmt}</p></div>
        <div class="metricas-linha">
          <div class="chuva"><span>‚òî Chuva (mm)</span><span>${chuvaTotal.toFixed(
            1
          )}</span></div>
          <div class="temp"><span>üå°Ô∏è Temperatura (¬∞C)</span><span>${tMin.toFixed(
            0
          )} a ${tMax.toFixed(0)}</span></div>
          <div class="vento"><span>üçÉ Vento (km/h)</span><span>${Math.round(
            vento
          )}</span></div>
          <div class="rajadas"><span>üçÉ Rajadas (km/h)</span><span>${Math.round(
            rajada
          )}</span></div>
          <div class="umid"><span>üíß Umidade (%)</span><span>${umidMin} a ${umidMax}</span></div>
        </div>
      `;
              const linhaHoras = document.createElement("div");
              linhaHoras.className = "cards-3h-container";
              const mesmoDia = data.toDateString() === agora.toDateString();
              regs.forEach((r) => {
                const hora = new Date(r.hora).getHours();
                const item = document.createElement("div");
                item.className = "card-3h";
                item.innerHTML = `<b>${String(hora).padStart(
                  2,
                  "0"
                )}h</b><div>${
                  weatherDescriptions[r.code] || "‚Äî"
                }, ${r.temp.toFixed(0)}¬∞C</div>`;
                if (mesmoDia && hora === agora.getHours()) {
                  item.classList.add("atual");
                  setTimeout(() => {
                    requestAnimationFrame(() => {
                      const primeiroCard = linhaHoras.firstElementChild;
                      const margemInicial = primeiroCard
                        ? primeiroCard.offsetLeft
                        : 0;
                      const offset =
                        item.offsetLeft -
                        linhaHoras.clientWidth / 2 +
                        item.clientWidth / 2 -
                        margemInicial;
                      linhaHoras.scrollTo({
                        left: Math.max(0, offset),
                        behavior: "smooth",
                      });
                    });
                  }, 400);
                }
                linhaHoras.appendChild(item);
              });
              card.appendChild(linhaHoras);
              const alertas = [];
              if (riscoTrovoadas) alertas.push("Alerta: Trovoadas!");
              if (chuvaTotal > 15) alertas.push("Alerta: Chuva forte!");
              if (umidMin < 30) alertas.push("Alerta: Baixa umidade!");
              if (rajada >= 40) alertas.push("Alerta: Rajadas de vento!");
              alertas.forEach((txt) => {
                const p = document.createElement("p");
                p.className = "alerta";
                p.textContent = txt;
                card.appendChild(p);
              });
              container.appendChild(card);
            }
          });
      }
      function fetchLocal(lat, lon) {
        fetch(
          `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`
        )
          .then((r) => r.json())
          .then((d) => {
            const a = d.address || {};
            const nome = `${a.city || a.town || a.village || ""}${
              a.state ? ", " + a.state : ""
            }${a.country ? ", " + a.country : ""}`;
            document.getElementById("location").textContent =
              "üìå " + (nome || "Localiza√ß√£o desconhecida");
          });
      }
      function buscarCidade(cidade) {
        fetch(
          `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(
            cidade
          )}&accept-language=pt`
        )
          .then((r) => r.json())
          .then((d) => {
            if (!d.length) return alert("Cidade n√£o encontrada.");
            const { lat, lon } = d[0];
            fetchLocal(lat, lon);
            fetchTempo(lat, lon);
            document.getElementById("city-input").value = "";
          });
      }
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude: lat, longitude: lon } = pos.coords;
            fetchLocal(lat, lon);
            fetchTempo(lat, lon);
          },
          () => {
            const lat = -9.7811,
              lon = -36.0936;
            fetchLocal(lat, lon);
            fetchTempo(lat, lon);
          }
        );
      }
      document.getElementById("search-btn").addEventListener("click", () => {
        const cidade = document.getElementById("city-input").value.trim();
        if (cidade) buscarCidade(cidade);
      });
    </script>
  </body>
</html>
