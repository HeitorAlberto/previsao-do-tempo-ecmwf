<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsão do Tempo - ECMWF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap');

        body {
            font-family: "Ubuntu", sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            font-size: 28px;
        }

        h2 {
            margin-top: 20px;
            text-align: center;
            font-size: 22px;
        }

        #search-box {
            margin-bottom: 15px;
            text-align: center;
        }

        #search-box input {
            font-size: 22px;
            width: 450px;
            padding: 8px;
            font-family: "Ubuntu", sans-serif;
        }

        #search-box button {
            font-size: 22px;
            margin-left: 5px;
            padding: 8px 12px;
            font-family: "Ubuntu", sans-serif;
        }

        #location {
            margin: 30px 0;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }

        .metricas-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 14px 16px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            box-sizing: border-box;
            cursor: pointer;
        }

        .info-group {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            justify-content: flex-end;
            align-items: center;
        }

        .card p {
            margin: 0;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 22px;
        }

        .dia-data {
            font-weight: bolder;
            font-size: 22px;
        }

        .chuva {
            background-color: #b9e3ff;
            color: #000000;
            font-weight: 500;
            width: 90px;
            text-align: center;
        }

        .temp {
            background-color: #ff9b6f;
            color: #000000;
            font-weight: 500;
            width: 90px;
            text-align: center;
        }

        .umid {
            background-color: #b9e3ff;
            color: #000000;
            font-weight: 500;
            width: 90px;
            text-align: center;
        }

        .vento {
            background-color: #90ff7f;
            color: #000000;
            font-weight: 500;
            width: 90px;
            text-align: center;
        }

        /* Div de detalhes (horas) */
        .weather-details {
            max-height: 0;
            overflow: hidden;
            background: #fff;
            border-radius: 8px;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            box-sizing: border-box;
            border-top: 1px solid #ddd;
        }

        .weather-details.open {
            max-height: 3000px;
            padding: 10px 16px;
        }

        .weather-details p {
            display: flex;
            gap: 20px;
            margin: 3px 0;
            border-bottom: 1px solid #eee;
            padding: 10px 10px;
            font-size: 20px;
        }

        .current-hour {
            background-color: #befaff;
            border-radius: 4px;
            padding-left: 5px;
        }


        @media (max-width: 600px) {
            #search-box input {
                width: 80%;
                font-size: 16px;
                text-align: center;
                margin-bottom: 10px;
            }

            .card p {
                font-size: 20px;
            }

            .weather-details p {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>

    <h1>Previsão 15 dias - ECMWF (Alta resolução - 9km)</h1>

    <div id="search-box">
        <input type="text" id="city-input" placeholder="Digite a cidade">
        <button id="search-btn">Buscar</button>
    </div>

    <div id="location">Carregando localização...</div>

    <div class="metricas-grid">
        <div class="metrica">
            <h2>Chuva (mm) e Temperatura (°C)</h2>
            <div id="chuva" class="cards"></div>
        </div>
        <div class="metrica">
            <h2>Umidade (%) e Vento/Rajadas (km/h)</h2>
            <div id="umidade" class="cards"></div>
        </div>
    </div>

    <script>
        const weatherDescriptions = {
            0: "Céu limpo",
            1: "Parcialmente nublado",
            2: "Muitas nuvens",
            3: "Nublado",
            45: "Névoa",
            48: "Neblina",
            51: "Chuvisco fraco",
            53: "Chuvisco moderado",
            55: "Chuvisco forte",
            56: "Chuvisco congelante fraco",
            57: "Chuvisco congelante forte",
            61: "Chuva fraca",
            63: "Chuva moderada",
            65: "Chuva forte",
            66: "Chuva congelante fraca",
            67: "Chuva congelante forte",
            71: "Neve fraca",
            73: "Neve moderada",
            75: "Neve forte",
            77: "Cristais de gelo",
            80: "Pancadas de chuva fraca",
            81: "Pancadas de chuva moderada",
            82: "Pancadas de chuva forte",
            85: "Pancadas de neve fraca",
            86: "Pancadas de neve forte",
            95: "Risco de trovoadas",
            96: "Tempestades com granizo",
            99: "Tempestades fortes com granizo"
        };

        function clearIfExists(id) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        }

        function createWeatherMenu(list, isToday) {
            const div = document.createElement('div');
            div.classList.add('weather-details');

            const currentHour = new Date().getHours();

            list.sort((a, b) => a.hora - b.hora);

            for (let h = 0; h < 24; h++) {
                const found = list.find(item => item.hora === h);
                const desc = found ? (weatherDescriptions[found.code] || `Código ${found.code}`) : "Sem dados";

                const p = document.createElement('p');
                p.innerHTML = `<span><b>${String(h).padStart(2, '0')}:00</b></span><span style="color: gray;">${desc}</span>`;

                if (isToday && h === currentHour) {
                    p.classList.add('current-hour');
                }

                div.appendChild(p);
            }

            return div;
        }

        function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,wind_gusts_10m,weathercode&models=ecmwf_ifs&timezone=auto&forecast_days=14`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (!data?.hourly?.time) return;

                    const { time, temperature_2m, precipitation, wind_speed_10m, wind_gusts_10m, relative_humidity_2m, weathercode } = data.hourly;

                    const dailyData = {};

                    for (let i = 0; i < time.length; i++) {
                        const date = new Date(time[i]);
                        const key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;

                        if (!dailyData[key]) {
                            dailyData[key] = {
                                tMin: temperature_2m[i],
                                tMax: temperature_2m[i],
                                chuva: precipitation[i] || 0,
                                umidMin: relative_humidity_2m[i],
                                umidMax: relative_humidity_2m[i],
                                vento: wind_speed_10m[i],
                                rajada: wind_gusts_10m[i],
                                weatherHours: []
                            };
                        }

                        const d = dailyData[key];
                        d.tMin = Math.min(d.tMin, temperature_2m[i]);
                        d.tMax = Math.max(d.tMax, temperature_2m[i]);
                        d.chuva += precipitation[i] || 0;
                        d.umidMin = Math.min(d.umidMin, relative_humidity_2m[i]);
                        d.umidMax = Math.max(d.umidMax, relative_humidity_2m[i]);
                        d.vento = Math.max(d.vento, wind_speed_10m[i]);
                        d.rajada = Math.max(d.rajada, wind_gusts_10m[i]);
                        d.weatherHours.push({ hora: date.getHours(), code: weathercode[i] });
                    }

                    clearIfExists('chuva');
                    clearIfExists('umidade');

                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                    const sortedKeys = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));

                    const hojeStr = `${new Date().getFullYear()}-${new Date().getMonth() + 1}-${new Date().getDate()}`;

                    const chuvaDiv = document.getElementById('chuva');
                    const umidDiv = document.getElementById('umidade');

                    sortedKeys.forEach(key => {
                        const { tMin, tMax, chuva, umidMin, umidMax, vento, rajada, weatherHours } = dailyData[key];
                        const [y, m, d] = key.split('-');
                        const dateObj = new Date(y, m - 1, d);
                        const nome = dayNames[dateObj.getDay()];
                        const dataFmt = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}`;

                        const isToday = key === hojeStr;

                        const card1 = document.createElement('div');
                        card1.classList.add('card');
                        card1.innerHTML = `
              <p class="dia-data">${nome}, ${dataFmt}</p>
              <div class="info-group">
                <p class="chuva">${chuva.toFixed(1)}</p>
                <p class="temp">${tMin.toFixed(0)} - ${tMax.toFixed(0)}</p>
              </div>`;
                        const details1 = createWeatherMenu(weatherHours, isToday);
                        card1.addEventListener('click', () => {
                            if (details1.classList.contains('open')) {
                                details1.classList.remove('open');
                                details1.style.maxHeight = '0';
                                details1.style.padding = '0 16px';
                            } else {
                                details1.classList.add('open');
                                details1.style.maxHeight = '3000px';
                                details1.style.padding = '10px 16px';
                            }
                        });
                        chuvaDiv.appendChild(card1);
                        chuvaDiv.appendChild(details1);

                        const card2 = document.createElement('div');
                        card2.classList.add('card');
                        card2.innerHTML = `
              <p class="dia-data">${nome}, ${dataFmt}</p>
              <div class="info-group">
                <p class="umid">${Math.round(umidMin)} - ${Math.round(umidMax)}</p>
                <p class="vento">${Math.round(vento)} / ${Math.round(rajada)}</p>
              </div>`;
                        const details2 = createWeatherMenu(weatherHours, isToday);
                        card2.addEventListener('click', () => {
                            if (details2.classList.contains('open')) {
                                details2.classList.remove('open');
                                details2.style.maxHeight = '0';
                                details2.style.padding = '0 16px';
                            } else {
                                details2.classList.add('open');
                                details2.style.maxHeight = '3000px';
                                details2.style.padding = '10px 16px';
                            }
                        });
                        umidDiv.appendChild(card2);
                        umidDiv.appendChild(details2);
                    });
                });
        }

        function fetchLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=pt`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let nome = "Localização desconhecida";
                    if (data?.address) {
                        const a = data.address;
                        nome = `${a.city || a.town || a.village || ""}${a.state ? ", " + a.state : ""}${a.country ? ", " + a.country : ""}`;
                    }
                    document.getElementById('location').textContent = "📌 " + nome;
                });
        }

        function searchCity(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}&accept-language=pt`;
            fetch(url)
                .then(r => r.json())
                .then(d => {
                    if (d.length > 0) {
                        const lat = d[0].lat, lon = d[0].lon;
                        fetchLocationName(lat, lon);
                        fetchWeather(lat, lon);
                    } else alert("Cidade não encontrada.");
                });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lon } = pos.coords;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            }, () => {
                const lat = -9.7811, lon = -36.0936;
                fetchLocationName(lat, lon);
                fetchWeather(lat, lon);
            });
        }

        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('city-input').value.trim();
            if (city) searchCity(city);
        });
    </script>
</body>

</html>